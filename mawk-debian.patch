diff -urN mawk-1.3.3.org/array.c mawk-1.3.3/array.c
--- mawk-1.3.3.org/array.c	1996-09-18 03:07:09.000000000 +0200
+++ mawk-1.3.3/array.c	2006-02-03 18:20:22.000000000 +0100
@@ -112,8 +112,10 @@
             Int ival = d_to_I(d) ;
             if ((double)ival == d) {
                                       if (A->type == AY_SPLIT)
+					{
                                          if (ival >=1 && ival <= A->size) convert_split_array_to_table(A) ;
                                          else return ; /* ival not in range */
+					}
                                       ap = find_by_ival(A, ival, NO_CREATE) ;
                                       if (ap) { /* remove from the front of the ilist */
                                          DUAL_LINK *table = (DUAL_LINK*) A->ptr ;
diff -urN mawk-1.3.3.org/bi_funct.c mawk-1.3.3/bi_funct.c
--- mawk-1.3.3.org/bi_funct.c	1996-01-14 18:16:11.000000000 +0100
+++ mawk-1.3.3/bi_funct.c	2006-02-03 18:20:22.000000000 +0100
@@ -74,37 +74,36 @@
 #include "regexp.h"
 #include "repl.h"
 #include <math.h>
-
+#include <unistd.h>
 
 /* statics */
 static STRING *PROTO(gsub, (PTR, CELL *, char *, int)) ;
 static void PROTO(fplib_err, (char *, double, char *)) ;
 
-
 /* global for the disassembler */
 BI_REC bi_funct[] =
 {				/* info to load builtins */
 
-   "length", bi_length, 0, 1,	/* special must come first */
-   "index", bi_index, 2, 2,
-   "substr", bi_substr, 2, 3,
-   "sprintf", bi_sprintf, 1, 255,
-   "sin", bi_sin, 1, 1,
-   "cos", bi_cos, 1, 1,
-   "atan2", bi_atan2, 2, 2,
-   "exp", bi_exp, 1, 1,
-   "log", bi_log, 1, 1,
-   "int", bi_int, 1, 1,
-   "sqrt", bi_sqrt, 1, 1,
-   "rand", bi_rand, 0, 0,
-   "srand", bi_srand, 0, 1,
-   "close", bi_close, 1, 1,
-   "system", bi_system, 1, 1,
-   "toupper", bi_toupper, 1, 1,
-   "tolower", bi_tolower, 1, 1,
-   "fflush", bi_fflush, 0, 1,
+   {"length", bi_length, 0, 1},	/* special must come first */
+   {"index", bi_index, 2, 2},
+   {"substr", bi_substr, 2, 3},
+   {"sprintf", bi_sprintf, 1, 255},
+   {"sin", bi_sin, 1, 1},
+   {"cos", bi_cos, 1, 1},
+   {"atan2", bi_atan2, 2, 2},
+   {"exp", bi_exp, 1, 1},
+   {"log", bi_log, 1, 1},
+   {"int", bi_int, 1, 1},
+   {"sqrt", bi_sqrt, 1, 1},
+   {"rand", bi_rand, 0, 0},
+   {"srand", bi_srand, 0, 1},
+   {"close", bi_close, 1, 1},
+   {"system", bi_system, 1, 1},
+   {"toupper", bi_toupper, 1, 1},
+   {"tolower", bi_tolower, 1, 1},
+   {"fflush", bi_fflush, 0, 1},
 
-   (char *) 0, (PF_CP) 0, 0, 0} ;
+   {(char *) 0, (PF_CP) 0, 0, 0}} ;
 
 
 /* load built-in functions in symbol table */
@@ -175,7 +174,7 @@
       case 2:
 	 {
 	    int k1 = key[1] ;
-	    while (target = strchr(target, k))
+	    while ((target = strchr(target, k)))
 	       if (target[1] == k1)  return target ;
 	       else  target++ ;
 	    /*failed*/
@@ -184,7 +183,7 @@
    }
 
    key_len-- ;
-   while (target = strchr(target, k))
+   while ((target = strchr(target, k)))
    {
       if (strncmp(target + 1, key + 1, key_len) == 0)  return target ;
       else  target++ ;
@@ -206,7 +205,7 @@
    sp-- ;
    if (TEST2(sp) != TWO_STRINGS)  cast2_to_s(sp) ;
 
-   if (len = string(sp + 1)->len)
+   if ((len = string(sp + 1)->len))
       idx = (p = str_str(string(sp)->str, string(sp + 1)->str, len))
 	 ? p - string(sp)->str + 1 : 0 ;
 
@@ -240,7 +239,7 @@
 
    if ((len = sval->len) == 0)	/* substr on null string */
    {
-      if (n_args == 3)	cell_destroy(sp + 2) ;
+      if (n_args == 3) { cell_destroy(sp + 2) ; }
       cell_destroy(sp + 1) ;
       return sp ;
    }
@@ -831,7 +830,7 @@
    if (sc.type < C_STRING)  cast1_to_s(&sc) ;
    front = string(&sc)->str ;
 
-   if (middle = REmatch(front, sp->ptr, &middle_len))
+   if ((middle = REmatch(front, sp->ptr, &middle_len)))
    {
       front_len = middle - front ;
       back = middle + middle_len ;
diff -urN mawk-1.3.3.org/configure mawk-1.3.3/configure
--- mawk-1.3.3.org/configure	1996-09-05 01:43:01.000000000 +0200
+++ mawk-1.3.3/configure	2006-02-03 18:20:31.000000000 +0100
@@ -532,6 +532,8 @@
 log()
 ; return 0; }
 EOF
+XCFLAGS=$CFLAGS
+CFLAGS="-fno-builtin $CFLAGS"
 if eval $ac_link; then
   rm -rf conftest*
   eval "ac_cv_lib_m=yes"
@@ -540,6 +542,7 @@
   eval "ac_cv_lib_m=no"
 fi
 rm -f conftest*
+CFLAGS=$XCFLAGS
 LIBS="$ac_save_LIBS"
 
 fi
diff -urN mawk-1.3.3.org/da.c mawk-1.3.3/da.c
--- mawk-1.3.3.org/da.c	1995-06-18 21:19:59.000000000 +0200
+++ mawk-1.3.3/da.c	2006-02-03 18:20:22.000000000 +0100
@@ -68,65 +68,65 @@
 } simple_code[] =
 
 {
-   _STOP, "stop",
-   FE_PUSHA, "fe_pusha",
-   FE_PUSHI, "fe_pushi",
-   A_TEST, "a_test",
-   A_DEL, "a_del",
-   DEL_A, "del_a",
-   POP_AL, "pop_al",
-   _POP, "pop",
-   _ADD, "add",
-   _SUB, "sub",
-   _MUL, "mul",
-   _DIV, "div",
-   _MOD, "mod",
-   _POW, "pow",
-   _NOT, "not",
-   _UMINUS, "uminus",
-   _UPLUS, "uplus",
-   _TEST, "test",
-   _CAT, "cat",
-   _ASSIGN, "assign",
-   _ADD_ASG, "add_asg",
-   _SUB_ASG, "sub_asg",
-   _MUL_ASG, "mul_asg",
-   _DIV_ASG, "div_asg",
-   _MOD_ASG, "mod_asg",
-   _POW_ASG, "pow_asg",
-   NF_PUSHI, "nf_pushi",
-   F_ASSIGN, "f_assign",
-   F_ADD_ASG, "f_add_asg",
-   F_SUB_ASG, "f_sub_asg",
-   F_MUL_ASG, "f_mul_asg",
-   F_DIV_ASG, "f_div_asg",
-   F_MOD_ASG, "f_mod_asg",
-   F_POW_ASG, "f_pow_asg",
-   _POST_INC, "post_inc",
-   _POST_DEC, "post_dec",
-   _PRE_INC, "pre_inc",
-   _PRE_DEC, "pre_dec",
-   F_POST_INC, "f_post_inc",
-   F_POST_DEC, "f_post_dec",
-   F_PRE_INC, "f_pre_inc",
-   F_PRE_DEC, "f_pre_dec",
-   _EQ, "eq",
-   _NEQ, "neq",
-   _LT, "lt",
-   _LTE, "lte",
-   _GT, "gt",
-   _GTE, "gte",
-   _MATCH2, "match2",
-   _EXIT, "exit",
-   _EXIT0, "exit0",
-   _NEXT, "next",
-   _RET, "ret",
-   _RET0, "ret0",
-   _OMAIN, "omain",
-   _JMAIN, "jmain",
-   OL_GL, "ol_gl",
-   OL_GL_NR, "ol_gl_nr",
-   _HALT, (char *) 0
+   {_STOP, "stop"},
+   {FE_PUSHA, "fe_pusha"},
+   {FE_PUSHI, "fe_pushi"},
+   {A_TEST, "a_test"},
+   {A_DEL, "a_del"},
+   {DEL_A, "del_a"},
+   {POP_AL, "pop_al"},
+   {_POP, "pop"},
+   {_ADD, "add"},
+   {_SUB, "sub"},
+   {_MUL, "mul"},
+   {_DIV, "div"},
+   {_MOD, "mod"},
+   {_POW, "pow"},
+   {_NOT, "not"},
+   {_UMINUS, "uminus"},
+   {_UPLUS, "uplus"},
+   {_TEST, "test"},
+   {_CAT, "cat"},
+   {_ASSIGN, "assign"},
+   {_ADD_ASG, "add_asg"},
+   {_SUB_ASG, "sub_asg"},
+   {_MUL_ASG, "mul_asg"},
+   {_DIV_ASG, "div_asg"},
+   {_MOD_ASG, "mod_asg"},
+   {_POW_ASG, "pow_asg"},
+   {NF_PUSHI, "nf_pushi"},
+   {F_ASSIGN, "f_assign"},
+   {F_ADD_ASG, "f_add_asg"},
+   {F_SUB_ASG, "f_sub_asg"},
+   {F_MUL_ASG, "f_mul_asg"},
+   {F_DIV_ASG, "f_div_asg"},
+   {F_MOD_ASG, "f_mod_asg"},
+   {F_POW_ASG, "f_pow_asg"},
+   {_POST_INC, "post_inc"},
+   {_POST_DEC, "post_dec"},
+   {_PRE_INC, "pre_inc"},
+   {_PRE_DEC, "pre_dec"},
+   {F_POST_INC, "f_post_inc"},
+   {F_POST_DEC, "f_post_dec"},
+   {F_PRE_INC, "f_pre_inc"},
+   {F_PRE_DEC, "f_pre_dec"},
+   {_EQ, "eq"},
+   {_NEQ, "neq"},
+   {_LT, "lt"},
+   {_LTE, "lte"},
+   {_GT, "gt"},
+   {_GTE, "gte"},
+   {_MATCH2, "match2"},
+   {_EXIT, "exit"},
+   {_EXIT0, "exit0"},
+   {_NEXT, "next"},
+   {_RET, "ret"},
+   {_RET0, "ret0"},
+   {_OMAIN, "omain"},
+   {_JMAIN, "jmain"},
+   {OL_GL, "ol_gl"},
+   {OL_GL_NR, "ol_gl_nr"},
+   {_HALT, (char *) 0}
 } ;
 
 static char *jfmt = "%s%s%03d\n" ; 
@@ -367,12 +367,12 @@
 }
 special_cases[] =
 {
-   bi_split, "split",
-   bi_match, "match",
-   bi_getline, "getline",
-   bi_sub, "sub",
-   bi_gsub, "gsub",
-   (PF_CP) 0, (char *) 0
+   {bi_split, "split"},
+   {bi_match, "match"},
+   {bi_getline, "getline"},
+   {bi_sub, "sub"},
+   {bi_gsub, "gsub"},
+   {(PF_CP) 0, (char *) 0}
 } ;
 
 static char *
diff -urN mawk-1.3.3.org/error.c mawk-1.3.3/error.c
--- mawk-1.3.3.org/error.c	1995-06-06 02:18:22.000000000 +0200
+++ mawk-1.3.3/error.c	2006-02-03 18:20:22.000000000 +0100
@@ -68,54 +68,54 @@
 static struct token_str  {
 short token ;
 char *str ; }  token_str[] = {
-EOF , "end of file" ,
-NL , "end of line",
-SEMI_COLON , ";" ,
-LBRACE , "{" ,
-RBRACE , "}" ,
-SC_FAKE_SEMI_COLON, "}",
-LPAREN , "(" ,
-RPAREN , ")" ,
-LBOX , "[",
-RBOX , "]",
-QMARK , "?",
-COLON , ":",
-OR, "||",
-AND, "&&",
-ASSIGN , "=" ,
-ADD_ASG, "+=",
-SUB_ASG, "-=",
-MUL_ASG, "*=",
-DIV_ASG, "/=",
-MOD_ASG, "%=",
-POW_ASG, "^=",
-EQ  , "==" ,
-NEQ , "!=",
-LT, "<" ,
-LTE, "<=" ,
-GT, ">",
-GTE, ">=" ,
-MATCH, string_buff,
-PLUS , "+" ,
-MINUS, "-" ,
-MUL , "*" ,
-DIV, "/"  , 
-MOD, "%" ,
-POW, "^" ,
-NOT, "!" ,
-COMMA, "," ,
-INC_or_DEC , string_buff ,
-DOUBLE  , string_buff ,
-STRING_  , string_buff ,
-ID  , string_buff ,
-FUNCT_ID  , string_buff ,
-BUILTIN  , string_buff ,
-IO_OUT , string_buff ,
-IO_IN, "<" ,
-PIPE, "|" ,
-DOLLAR, "$" ,
-FIELD, "$" ,
-0, (char *) 0 } ;
+{EOF , "end of file" },
+{NL , "end of line"},
+{SEMI_COLON , ";" },
+{LBRACE , "{" },
+{RBRACE , "}" },
+{SC_FAKE_SEMI_COLON, "}"},
+{LPAREN , "(" },
+{RPAREN , ")" },
+{LBOX , "["},
+{RBOX , "]"},
+{QMARK , "?"},
+{COLON , ":"},
+{OR, "||"},
+{AND, "&&"},
+{ASSIGN , "=" },
+{ADD_ASG, "+="},
+{SUB_ASG, "-="},
+{MUL_ASG, "*="},
+{DIV_ASG, "/="},
+{MOD_ASG, "%="},
+{POW_ASG, "^="},
+{EQ  , "==" },
+{NEQ , "!="},
+{LT, "<" },
+{LTE, "<=" },
+{GT, ">"},
+{GTE, ">=" },
+{MATCH, string_buff},
+{PLUS , "+" },
+{MINUS, "-" },
+{MUL , "*" },
+{DIV, "/"  },
+{MOD, "%" },
+{POW, "^" },
+{NOT, "!" },
+{COMMA, "," },
+{INC_or_DEC , string_buff },
+{DOUBLE  , string_buff },
+{STRING_  , string_buff },
+{ID  , string_buff },
+{FUNCT_ID  , string_buff },
+{BUILTIN  , string_buff },
+{IO_OUT , string_buff },
+{IO_IN, "<" },
+{PIPE, "|" },
+{DOLLAR, "$" },
+{FIELD, "$" },
+{0, (char *) 0 }} ;
 
 /* if paren_cnt >0 and we see one of these, we are missing a ')' */
 static int missing_rparen[] =
diff -urN mawk-1.3.3.org/fcall.c mawk-1.3.3/fcall.c
--- mawk-1.3.3.org/fcall.c	1995-08-27 17:46:47.000000000 +0200
+++ mawk-1.3.3/fcall.c	2006-02-03 18:20:22.000000000 +0100
@@ -86,7 +86,7 @@
        take q off entry_list
        test it
 	   if OK  zfree(q)  else put on exit_list  */  
-   while (q = entry_list)
+   while ((q = entry_list))
    {
       entry_list = q->link ;
 
@@ -235,8 +235,8 @@
       }
       /* note p->arg_list starts with last argument */
       else if (!p->arg_list /* nothing to do */	 ||
-	       !p->arg_cnt_checked &&
-	       !arg_cnt_ok(p->callee, p->arg_list, p->line_no))
+	       (!p->arg_cnt_checked &&
+		!arg_cnt_ok(p->callee, p->arg_list, p->line_no)))
       {
 	 q->link = p->link ;	 /* delete p */
 	 /* the ! arg_list case is not an error so free memory */
@@ -301,8 +301,8 @@
       p = old_list ;
       old_list = p->link ;
 
-      if (p->arg_list = call_arg_check(p->callee, p->arg_list,
-				       p->call_start, p->line_no))
+      if ((p->arg_list = call_arg_check(p->callee, p->arg_list,
+				       p->call_start, p->line_no)))
       {
 	 /* still have work to do , put on new_list   */
 	 progress |= check_progress ;
@@ -352,8 +352,8 @@
       /* usually arg_list disappears here and all is well
 	 otherwise add to resolve list */
 
-      if (arg_list = call_arg_check(callee, arg_list,
-				    code_base, line_no))
+      if ((arg_list = call_arg_check(callee, arg_list,
+				    code_base, line_no)))
       {
 	 p = ZMALLOC(FCALL_REC) ;
 	 p->callee = callee ;
diff -urN mawk-1.3.3.org/field.c mawk-1.3.3/field.c
--- mawk-1.3.3.org/field.c	1995-06-18 21:17:47.000000000 +0200
+++ mawk-1.3.3/field.c	2006-02-03 18:20:22.000000000 +0100
@@ -109,13 +109,15 @@
       scan_code['\n'] = SC_UNEXPECTED ;
 
    if (rs_shadow.type == SEP_STR)
-      free_STRING((STRING *) rs_shadow.ptr) ;
+     {
+       free_STRING((STRING *) rs_shadow.ptr) ;
+     }
 
    cast_for_split(cellcpy(&c, RS)) ;
    switch (c.type)
    {
       case C_RE:
-	 if (s = is_string_split(c.ptr, &len))
+	 if ((s = is_string_split(c.ptr, &len)))
 	 {
 	    if (len == 1)
 	    {
@@ -276,7 +278,7 @@
       field[cnt--].type = C_MBSTRN ;
    }
 
-   if (cp == &c)  free_STRING(string(cp)) ;
+   if (cp == &c) { free_STRING(string(cp)) ; }
 }
 
 /*
@@ -503,7 +505,7 @@
 	 memcpy(p, string(cp)->str, string(cp)->len) ;
 	 p += string(cp)->len ;
 	 /* if not really string, free temp use of ptr */
-	 if (cp->type < C_STRING)  free_STRING(string(cp)) ;
+	 if (cp->type < C_STRING) { free_STRING(string(cp)) ; }
 	 if (++cp == cp_limit)
 	 {
 	    cp = *++fbp ;
diff -urN mawk-1.3.3.org/files.c mawk-1.3.3/files.c
--- mawk-1.3.3.org/files.c	1996-01-14 18:14:10.000000000 +0100
+++ mawk-1.3.3/files.c	2006-02-03 18:20:22.000000000 +0100
@@ -61,17 +61,14 @@
 #include "memory.h"
 #include "fin.h"
 
-static FILE *PROTO(tfopen, (char *, char *)) ;
-static void PROTO(efflush, (FILE*)) ;
-static void PROTO(add_to_child_list, (int, int)) ;
-static struct child *PROTO(remove_from_child_list, (int)) ;
-extern int PROTO(isatty, (int)) ;
+#include <sys/types.h>
+#include <sys/wait.h>
+#include <unistd.h>
 
 #ifdef	V7
 #include  <sgtty.h>		/* defines FIOCLEX */
 #endif
 
-
 #ifndef	 NO_FCNTL_H
 
 #include <fcntl.h>
@@ -103,6 +100,14 @@
 
 static FILE_NODE *file_list ;
 
+/* Prototypes for local functions */
+
+static FILE *PROTO(tfopen, (char *, char *)) ;
+static void PROTO(efflush, (FILE*)) ;
+static void PROTO(add_to_child_list, (int, int)) ;
+static struct child *PROTO(remove_from_child_list, (int)) ;
+extern int PROTO(isatty, (int)) ;
+static void PROTO(close_error, (FILE_NODE *p));
 
 /* find a file on file_list */
 PTR
@@ -186,7 +191,7 @@
       if (strcmp(name, p->name->str) == 0 &&
 	  (p->type == type ||
       /* no distinction between F_APPEND and F_TRUNC here */
-	   p->type >= F_APPEND && type >= F_APPEND))
+	   (p->type >= F_APPEND && type >= F_APPEND)))
 
       {
 	 /* found */
@@ -233,16 +238,28 @@
       if (strcmp(name, p->name->str) == 0)
       {
 	 /* found */
-	 switch (p->type)
+
+         /* Remove it from the list first because we might be called 
+            again if an error occurs leading to an infinite loop. 
+
+            Note that we don't have to consider the list corruption 
+            caused by a recursive call because it will never return. */
+
+	 q->link = p->link ;
+         file_list = dummy.link ;   /* maybe it was the first file */
+         
+         switch (p->type)
 	 {
 	    case F_TRUNC:
 	    case F_APPEND:
-	       fclose((FILE *) p->ptr) ;
+	       if( fclose((FILE *) p->ptr) != 0 )
+		  close_error(p) ;
 	       retval = 0 ;
 	       break ;
 
 	    case PIPE_OUT:
-	       fclose((FILE *) p->ptr) ;
+	       if( fclose((FILE *) p->ptr) != 0 )
+	       	  close_error(p) ;
 
 #if  HAVE_REAL_PIPES
 	       retval = wait_for(p->pid) ;
@@ -274,8 +291,8 @@
 	 }
 
 	 free_STRING(p->name) ;
-	 hold = p ;
-	 q->link = p = p->link ;
+         hold = p ;
+	 p = p->link ;
 	 ZFREE(hold) ;
       }
       else
@@ -284,7 +301,6 @@
       }
    }
 
-   file_list = dummy.link ;
    return retval ;
 }
 
@@ -364,7 +380,14 @@
    {
       if (IS_OUTPUT(p->type))
       {
-	 fclose((FILE *) p->ptr) ;   
+	 if( fclose((FILE *) p->ptr) != 0 )
+         {
+            /* if another error occurs we do not want to be called 
+               for the same file again */
+
+            file_list = p->link ;
+	    close_error(p) ;
+         }
 	 if (p->type == PIPE_OUT) wait_for(p->pid) ; 
       }
 
@@ -397,7 +420,8 @@
    {
       if (p->type == PIPE_OUT)
       {
-	 fclose(p->ptr) ;
+	 if( fclose(p->ptr) != 0 )
+	    close_error(p) ;
 	 close_fake_outpipe(p->name->str, p->pid) ;
       }
       p = p->link ;
@@ -529,7 +553,7 @@
       add_to_child_list(id, exit_status) ;
    }
    /* see if an earlier wait() caught our child */
-   else if (p = remove_from_child_list(pid))
+   else if ((p = remove_from_child_list(pid)))
    {
       exit_status = p->exit_status ;
       ZFREE(p) ;
@@ -563,18 +587,24 @@
 set_stderr()   /* and stdout */
 {
    FILE_NODE *p, *q ; 
+
+   /* We insert stderr first to get it at the end of the list. This is 
+      needed because we want to output errors encountered on closing 
+      stdout. */
    
-   p = ZMALLOC(FILE_NODE) ;
-   p->link = (FILE_NODE*) 0 ;
-   p->type = F_TRUNC ;
-   p->name = new_STRING("/dev/stdout") ;
-   p->ptr = (PTR) stdout ;
    q = ZMALLOC(FILE_NODE);
-   q->link = p ;
+   q->link = (FILE_NODE*) 0 ;
    q->type = F_TRUNC ;
    q->name = new_STRING("/dev/stderr") ;
    q->ptr = (PTR) stderr ;
-   file_list = q ;
+
+   p = ZMALLOC(FILE_NODE) ;
+   p->link = q;
+   p->type = F_TRUNC ;
+   p->name = new_STRING("/dev/stdout") ;
+   p->ptr = (PTR) stdout ;
+
+   file_list = p ;
 }
 
 /* fopen() but no buffering to ttys */
@@ -619,3 +649,13 @@
    }
 }
 #endif /* MSDOS */
+
+/* An error occured closing the file referred to by P. We tell the 
+   user and terminate the program. */
+
+static void close_error(p)
+   FILE_NODE *p ;
+{
+   errmsg(errno, "close failed on file %s", p->name->str) ;
+   mawk_exit(2) ;
+}
diff -urN mawk-1.3.3.org/fin.c mawk-1.3.3/fin.c
--- mawk-1.3.3.org/fin.c	1995-12-24 23:23:22.000000000 +0100
+++ mawk-1.3.3/fin.c	2006-02-03 18:20:22.000000000 +0100
@@ -108,8 +108,8 @@
    fin->nbuffs = 1 ;
    fin->buff[0] = 0 ;
 
-   if (isatty(fd) && rs_shadow.type == SEP_CHAR && rs_shadow.c == '\n'
-       || interactive_flag && fd == 0 )
+   if ((isatty(fd) && rs_shadow.type == SEP_CHAR && rs_shadow.c == '\n')
+       || (interactive_flag && fd == 0) )
    {
       /* interactive, i.e., line buffer this file */
       if (fd == 0)  fin->fp = stdin ;
@@ -169,8 +169,10 @@
       zfree(fin->buff, fin->nbuffs * BUFFSZ + 1) ;
 
       if (fin->fd)
+	{
 	 if (fin->fp)  fclose(fin->fp) ;
 	 else  close(fin->fd) ;
+	}
 
       fin->buff = fin->buffp = &dead ;	 /* marks it semi_closed */
    }
diff -urN mawk-1.3.3.org/init.c mawk-1.3.3/init.c
--- mawk-1.3.3.org/init.c	1995-08-20 19:35:21.000000000 +0200
+++ mawk-1.3.3/init.c	2006-02-03 18:20:22.000000000 +0100
@@ -69,6 +69,7 @@
 #include "init.h"
 #include "bi_vars.h"
 #include "field.h"
+#include <stdlib.h>
 
 #ifdef MSDOS
 #include <fcntl.h>
@@ -370,7 +371,7 @@
 
    while (*p)
    {
-      if (s = strchr(*p, '='))	/* shouldn't fail */
+      if ((s = strchr(*p, '=')))	/* shouldn't fail */
       {
 	 int len = s - *p ;
 	 c.ptr = (PTR) new_STRING0(len) ;
diff -urN mawk-1.3.3.org/kw.c mawk-1.3.3/kw.c
--- mawk-1.3.3.org/kw.c	1993-07-17 15:22:59.000000000 +0200
+++ mawk-1.3.3/kw.c	2006-02-03 18:20:22.000000000 +0100
@@ -41,29 +41,29 @@
 keywords[] =
 {
 
-   "print", PRINT,
-   "printf", PRINTF,
-   "do", DO,
-   "while", WHILE,
-   "for", FOR,
-   "break", BREAK,
-   "continue", CONTINUE,
-   "if", IF,
-   "else", ELSE,
-   "in", IN,
-   "delete", DELETE,
-   "split", SPLIT,
-   "match", MATCH_FUNC,
-   "BEGIN", BEGIN,
-   "END", END,
-   "exit", EXIT,
-   "next", NEXT,
-   "return", RETURN,
-   "getline", GETLINE,
-   "sub", SUB,
-   "gsub", GSUB,
-   "function", FUNCTION,
-   (char *) 0, 0
+   {"print", PRINT},
+   {"printf", PRINTF},
+   {"do", DO},
+   {"while", WHILE},
+   {"for", FOR},
+   {"break", BREAK},
+   {"continue", CONTINUE},
+   {"if", IF},
+   {"else", ELSE},
+   {"in", IN},
+   {"delete", DELETE},
+   {"split", SPLIT},
+   {"match", MATCH_FUNC},
+   {"BEGIN", BEGIN},
+   {"END", END},
+   {"exit", EXIT},
+   {"next", NEXT},
+   {"return", RETURN},
+   {"getline", GETLINE},
+   {"sub", SUB},
+   {"gsub", GSUB},
+   {"function", FUNCTION},
+   {(char *) 0, 0}
 } ;
 
 /* put keywords in the symbol table */
diff -urN mawk-1.3.3.org/mawk.h mawk-1.3.3/mawk.h
--- mawk-1.3.3.org/mawk.h	1996-11-08 15:54:52.000000000 +0100
+++ mawk-1.3.3/mawk.h	2006-02-03 18:20:22.000000000 +0100
@@ -52,6 +52,7 @@
 
 #include  "nstd.h"
 #include <stdio.h>
+#include <unistd.h>
 #include "types.h"
 
 #ifdef   DEBUG
@@ -145,7 +146,7 @@
 void  PROTO( overflow, (char *, unsigned) ) ;
 void  PROTO( rt_overflow, (char *, unsigned) ) ;
 void  PROTO( rt_error, ( char *, ...) ) ;
-void  PROTO( mawk_exit, (int) ) ;
+void  PROTO( mawk_exit, (int) ) __attribute__ ((noreturn)) ;
 void PROTO( da, (INST *, FILE *)) ;
 char *PROTO( str_str, (char*, char*, unsigned) ) ;
 char *PROTO( rm_escape, (char *) ) ;
@@ -153,16 +154,13 @@
 int   PROTO( binmode, (void)) ;
 
 
-int   PROTO( close, (int) ) ;
-int   PROTO( read, (int , PTR, unsigned) ) ;
-
 void PROTO ( parse, (void) ) ;
 int  PROTO ( yylex, (void) ) ;
 int  PROTO( yyparse, (void) ) ;
 void PROTO( yyerror, (char *) ) ;
 void PROTO( scan_cleanup, (void)) ;
 
-void PROTO( bozo, (char *) ) ;
+void PROTO( bozo, (char *) ) __attribute__ ((noreturn));
 void PROTO( errmsg , (int, char*, ...) ) ;
 void PROTO( compile_error, ( char *, ...) ) ;
 
diff -urN mawk-1.3.3.org/parse.y mawk-1.3.3/parse.y
--- mawk-1.3.3.org/parse.y	1995-06-12 00:55:31.000000000 +0200
+++ mawk-1.3.3/parse.y	2006-02-03 18:20:26.000000000 +0100
@@ -274,6 +274,7 @@
                        code1(_PUSHINT) ; code1(0) ;
                        code2(_PRINT, bi_print) ;
                      }
+	;
 
 statement_list :  statement
         |  statement_list   statement
@@ -482,6 +483,7 @@
 /* an empty production to store the code_ptr */
 mark : /* empty */
          { $$ = code_offset ; }
+	;
 
 /* print_statement */
 statement :  print mark pr_args pr_direction separator
@@ -540,6 +542,7 @@
                 { patch_jmp(code_ptr) ; 
 		  patch_jmp(CDP($4)) ; 
 		}
+	;
 
 
 /*  LOOPS   */
@@ -883,7 +886,7 @@
                  } 
                }
              }
-                
+	;                
 
 
 /* exit_statement */
@@ -892,12 +895,14 @@
                       code1(_EXIT0) ; }
                |  EXIT   expr  separator
                     { $$ = $2 ; code1(_EXIT) ; }
+	;
 
 return_statement :  RETURN   separator
                     { $$ = code_offset ;
                       code1(_RET0) ; }
                |  RETURN   expr  separator
                     { $$ = $2 ; code1(_RET) ; }
+	;
 
 /* getline */
 
@@ -931,7 +936,7 @@
           }
        ;
 
-getline :   GETLINE  { getline_flag = 1 ; }
+getline :   GETLINE  { getline_flag = 1 ; } ;
 
 fvalue  :   lvalue  |  field  ;
 
diff -urN mawk-1.3.3.org/re_cmpl.c mawk-1.3.3/re_cmpl.c
--- mawk-1.3.3.org/re_cmpl.c	1994-12-13 01:14:58.000000000 +0100
+++ mawk-1.3.3/re_cmpl.c	2006-02-03 18:20:22.000000000 +0100
@@ -138,6 +138,8 @@
       if (p->re == m)  return p->sval->str ;
 #ifdef	DEBUG
    bozo("non compiled machine") ;
+#else
+   return NULL;
 #endif
 }
 
@@ -240,7 +242,7 @@
       p = (STRING **) cp->ptr ;
       for (cnt = cp->vcnt; cnt; cnt--)
       {
-	 if (*p)  free_STRING(*p) ;
+	 if (*p) { free_STRING(*p) ; }
 	 p++ ;
       }
       zfree(cp->ptr, cp->vcnt * sizeof(STRING *)) ;
@@ -365,6 +367,8 @@
 
 #if  DEBUG
    bozo("unable to uncompile an repl") ;
+#else
+   return NULL;
 #endif
 }
 
diff -urN mawk-1.3.3.org/rexp/rexp0.c mawk-1.3.3/rexp/rexp0.c
--- mawk-1.3.3.org/rexp/rexp0.c	1996-11-08 16:39:27.000000000 +0100
+++ mawk-1.3.3/rexp/rexp0.c	2006-02-03 18:20:22.000000000 +0100
@@ -113,7 +113,6 @@
 {
    register int c ;
 
-reswitch:
    switch (c = char2token(*lp))
    {
       case T_PLUS:
@@ -165,7 +164,7 @@
 	 {
 	    case T_ANY:
 	       {
-		  static plus_is_star_flag = 0 ;
+		  static int plus_is_star_flag = 0 ;
 
 		  if (*++lp == '*')
 		  {
@@ -560,14 +559,14 @@
 }
 escape_test[ET_END + 1] =
 {
-   'n', '\n',
-   't', '\t',
-   'f', '\f',
-   'b', '\b',
-   'r', '\r',
-   'a', '\07',
-   'v', '\013',
-   0, 0
+   {'n', '\n'},
+   {'t', '\t'},
+   {'f', '\f'},
+   {'b', '\b'},
+   {'r', '\r'},
+   {'a', '\07'},
+   {'v', '\013'},
+   {0, 0}
 } ;
 
 
diff -urN mawk-1.3.3.org/rexp/rexp3.c mawk-1.3.3/rexp/rexp3.c
--- mawk-1.3.3.org/rexp/rexp3.c	1993-07-24 19:55:15.000000000 +0200
+++ mawk-1.3.3/rexp/rexp3.c	2006-02-03 18:20:22.000000000 +0100
@@ -89,7 +89,7 @@
    /* check for the easy case */
    if ((m + 1)->type == M_ACCEPT && m->type == M_STR)
    {
-      if (ts = str_str(s, m->data.str, m->len))	 *lenp = m->len ;
+      if ((ts = str_str(s, m->data.str, m->len)))	 *lenp = m->len ;
       return ts ;
    }
 
@@ -315,7 +315,7 @@
 
       case M_ACCEPT + U_OFF:
 	 if (!ss)  ss = s ;
-	 if (!cb_ss || ss < cb_ss || ss == cb_ss && s > cb_e)
+	 if (!cb_ss || ss < cb_ss || (ss == cb_ss && s > cb_e))
 	 {
 	    /* we have a new current best */
 	    cb_ss = ss ; cb_e = s ;
@@ -326,7 +326,7 @@
 	 if (!ss)  ss = s ;
 	 else  s = str_end ? str_end : (str_end = s + strlen(s)) ;
 
-	 if (!cb_ss || ss < cb_ss || ss == cb_ss && s > cb_e)
+	 if (!cb_ss || ss < cb_ss || (ss == cb_ss && s > cb_e))
 	 {
 	    /* we have a new current best */
 	    cb_ss = ss ; cb_e = s ;
diff -urN mawk-1.3.3.org/rexp/rexp.c mawk-1.3.3/rexp/rexp.c
--- mawk-1.3.3.org/rexp/rexp.c	1996-09-02 20:47:36.000000000 +0200
+++ mawk-1.3.3/rexp/rexp.c	2006-02-03 18:20:22.000000000 +0100
@@ -65,14 +65,14 @@
 static  short  table[8][8]  =  {
 
 /*        0   |   CAT   *   +   ?   (   )   */
-/* 0 */   0,  L,  L,    L,  L,  L,  L,  E1,
-/* | */   G,  G,  L,    L,  L,  L,  L,  G,
-/* CAT*/  G,  G,  G,    L,  L,  L,  L,  G,
-/* * */   G,  G,  G,    G,  G,  G, E7,  G,
-/* + */   G,  G,  G,    G,  G,  G, E7,  G,
-/* ? */   G,  G,  G,    G,  G,  G, E7,  G,
-/* ( */   E2, L,  L,    L,  L,  L,  L,  EQ,
-/* ) */   G , G,  G,    G,  G,  G,  E7,  G     }   ;
+/* 0 */   {0,  L,  L,    L,  L,  L,  L,  E1},
+/* | */   {G,  G,  L,    L,  L,  L,  L,  G},
+/* CAT*/  {G,  G,  G,    L,  L,  L,  L,  G},
+/* * */   {G,  G,  G,    G,  G,  G, E7,  G},
+/* + */   {G,  G,  G,    G,  G,  G, E7,  G},
+/* ? */   {G,  G,  G,    G,  G,  G, E7,  G},
+/* ( */   {E2, L,  L,    L,  L,  L,  L,  EQ},
+/* ) */   {G , G,  G,    G,  G,  G,  E7,  G}     }   ;
 
 
 #define	 STACKSZ   64
diff -urN mawk-1.3.3.org/rexp/rexp.h mawk-1.3.3/rexp/rexp.h
--- mawk-1.3.3.org/rexp/rexp.h	1993-07-23 15:21:35.000000000 +0200
+++ mawk-1.3.3/rexp/rexp.h	2006-02-03 18:20:22.000000000 +0100
@@ -152,7 +152,7 @@
 void      PROTO( RE_close, (MACHINE *) ) ;
 void      PROTO( RE_poscl, (MACHINE *) ) ;
 void      PROTO( RE_01, (MACHINE *) ) ;
-void      PROTO( RE_panic, (char *) ) ;
+void      PROTO( RE_panic, (char *) ) __attribute__((noreturn)) ;
 char     *PROTO( str_str, (char *, char *, unsigned) ) ;
 
 void      PROTO( RE_lex_init , (char *) ) ;
diff -urN mawk-1.3.3.org/scan.c mawk-1.3.3/scan.c
--- mawk-1.3.3.org/scan.c	1996-07-28 23:47:05.000000000 +0200
+++ mawk-1.3.3/scan.c	2006-02-03 18:20:23.000000000 +0100
@@ -420,7 +420,7 @@
 	    {
 	       if (*p == current_token)
 	       {
-		  if (*p != INC_or_DEC)	 test1_ret('=', DIV_ASG, DIV) ;
+		  if (*p != INC_or_DEC)	{ test1_ret('=', DIV_ASG, DIV) ; }
 
 		  if (next() == '=')
 		  {
@@ -852,7 +852,7 @@
 #define	 hex_value(x)	hex_val[(x)-'A']
 
 #define ishex(x) (scan_code[x] == SC_DIGIT ||\
-		  'A' <= (x) && (x) <= 'f' && hex_value(x))
+		  ('A' <= (x) && (x) <= 'f' && hex_value(x)))
 
 static int PROTO(octal, (char **)) ;
 static int PROTO(hex, (char **)) ;
@@ -909,16 +909,16 @@
 }
 escape_test[ET_END + 1] =
 {
-   'n', '\n',
-   't', '\t',
-   'f', '\f',
-   'b', '\b',
-   'r', '\r',
-   'a', '\07',
-   'v', '\013',
-   '\\', '\\',
-   '\"', '\"',
-   0, 0
+  {'n', '\n'},
+  {'t', '\t'},
+  {'f', '\f'},
+  {'b', '\b'},
+  {'r', '\r'},
+  {'a', '\07'},
+  {'v', '\013'},
+  {'\\', '\\'},
+  {'\"', '\"'},
+  {0, 0}
 } ;
 
 
diff -urN mawk-1.3.3.org/split.c mawk-1.3.3/split.c
--- mawk-1.3.3.org/split.c	1996-02-01 06:05:43.000000000 +0100
+++ mawk-1.3.3/split.c	2006-02-03 18:20:23.000000000 +0100
@@ -164,7 +164,7 @@
    register char *s ;
 PTR re ; unsigned *lenp ;
 {
-   while (s = REmatch(s, re, lenp))
+   while ((s = REmatch(s, re, lenp)))
       if (*lenp)  return s ;
       else if (*s == 0)	 break ;
       else  s++ ;
@@ -225,7 +225,7 @@
    char *t ;
    unsigned len, mlen ;
 
-   while (t = re_pos_match(s, re, &mlen))
+   while ((t = re_pos_match(s, re, &mlen)))
    {
       tail = tail->link = ZMALLOC(SPLIT_OV) ;
       tail->sval = new_STRING0(len = t - s) ;
diff -urN mawk-1.3.3.org/test/full-awk.dat mawk-1.3.3/test/full-awk.dat
--- mawk-1.3.3.org/test/full-awk.dat	1970-01-01 01:00:00.000000000 +0100
+++ mawk-1.3.3/test/full-awk.dat	2006-02-03 18:20:14.000000000 +0100
@@ -0,0 +1,3 @@
+This has to be a small file to check if mawk handles write errors correctly 
+even on a full disk. It has to be smaller than the write buffer of the 
+C library.
diff -urN mawk-1.3.3.org/test/mawktest mawk-1.3.3/test/mawktest
--- mawk-1.3.3.org/test/mawktest	1993-07-03 20:58:38.000000000 +0200
+++ mawk-1.3.3/test/mawktest	2006-02-03 18:20:28.000000000 +0100
@@ -39,6 +39,22 @@
 #######################################
 
 echo
+if [ -c /dev/full ]; then
+    echo testing checking for write errors
+    # Check for write errors noticed when closing the file
+    mawk '{print}' <full-awk.dat >/dev/full 2>/dev/null && exit
+    # Check for write errors noticed on writing
+    # The file has to be bigger than the buffer size of the libc
+    mawk '{print}' <../scan.c >/dev/full 2>/dev/null && exit
+
+    echo checking for write errors OK
+else
+    echo "No /dev/full - check for write errors skipped"
+fi
+
+#######################################
+
+echo
 echo testing arrays and flow of control
 
 mawk -f wfrq0.awk $dat | cmp -s - wfrq-awk.out || exit
diff -urN mawk-1.3.3.org/version.c mawk-1.3.3/version.c
--- mawk-1.3.3.org/version.c	1996-07-28 23:47:07.000000000 +0200
+++ mawk-1.3.3/version.c	2006-02-03 18:20:23.000000000 +0100
@@ -46,6 +46,9 @@
 #define DOS_STRING	""
 #endif
 
+int print_compiler_id();
+int print_aux_limits();
+
 static char fmt[] = "%-14s%10lu\n" ;
 
 /* print VERSION and exit */
diff -urN mawk-1.3.3.org/zmalloc.c mawk-1.3.3/zmalloc.c
--- mawk-1.3.3.org/zmalloc.c	1995-06-06 02:18:35.000000000 +0200
+++ mawk-1.3.3/zmalloc.c	2006-02-03 18:20:23.000000000 +0100
@@ -115,7 +115,7 @@
       return (PTR) p ;
    }
 
-   if (p = pool[blocks - 1])
+   if ((p = pool[blocks - 1]))
    {
       pool[blocks - 1] = p->link ;
       return (PTR) p ;
